<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dijital Kuran Hocam</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: #f4f7f6;
            color: #333;
        }

        .card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        h1 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 24px;
        }

        .subtitle {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .status {
            margin-bottom: 25px;
            font-weight: 600;
            color: #95a5a6;
            min-height: 24px;
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 50px;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 6px rgba(39, 174, 96, 0.2);
        }

        button:hover {
            background: #2ecc71;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(39, 174, 96, 0.3);
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .active {
            color: #27ae60;
        }

        .error {
            color: #e74c3c;
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>üìñ Dijital Kuran Hocam</h1>
        <div class="subtitle">Yapay Zeka Destekli Kuran √ñƒüretmeni</div>

        <!-- Web Call Section -->
        <div>
            <div id="status" class="status">Ders ƒ∞√ßin Hazƒ±r</div>
            <button id="toggleBtn">Hocayla Konu≈ümaya Ba≈üla</button>
        </div>

        <!-- Phone Call Section Removed for simplicity in this demo, or can be kept if needed. Keeping simple for now to focus on the conversion. 
             If user wants phone call, we can re-add or just hide it. Let's comment it out to clean up the interface for the Quran app vibe. -->
        <!-- 
        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
            <h3>üì± Telefonla Arat</h3>
            ...
        </div> 
        -->
    </div>

    <!-- Phone Call Section -->
    <div>
        <h3>üì± Telefonla Arat (Outbound)</h3>
        <input type="text" id="phoneNumber" placeholder="+905551234567"
            style="padding: 10px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; width: 200px; margin-bottom: 10px;">
        <br>
        <button id="callBtn" style="background: #28a745;">Telefonumu Ara</button>
        <div id="phoneStatus" class="status" style="margin-top: 10px;"></div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/retell-client-js-sdk@latest/dist/index.umd.js"></script>
    <script>
        const retellWebClient = new retell.RetellWebClient();
        const toggleBtn = document.getElementById('toggleBtn');
        const statusEl = document.getElementById('status');
        let isCalling = false;

        // Listen to events
        retellWebClient.on("call_started", () => {
            console.log("Call started");
            statusEl.textContent = "üìû G√∂r√º≈üme S√ºr√ºyor...";
            statusEl.className = "status active";
            toggleBtn.textContent = "G√∂r√º≈ümeyi Bitir";
            toggleBtn.style.background = "#dc3545";
        });

        retellWebClient.on("call_ended", () => {
            console.log("Call ended");
            resetUI();
        });

        retellWebClient.on("error", (error) => {
            console.error("Error:", error);
            statusEl.textContent = "‚ùå Hata: " + error.message;
            statusEl.className = "status error";
            resetUI();
        });

        function resetUI() {
            statusEl.textContent = "Aramaya Hazƒ±r";
            statusEl.className = "status";
            toggleBtn.textContent = "Konu≈ümayƒ± Ba≈ülat";
            toggleBtn.style.background = "#007bff";
            toggleBtn.disabled = false;
            isCalling = false;
        }

        toggleBtn.addEventListener('click', async () => {
            if (isCalling) {
                retellWebClient.stopCall();
            } else {
                toggleBtn.disabled = true;
                statusEl.textContent = "Baƒülanƒ±yor...";

                try {
                    // Get Access Token from our server
                    const response = await fetch("/register-call", { method: "POST" });
                    if (!response.ok) throw new Error("Token alƒ±namadƒ±");

                    const data = await response.json();

                    // Start Call
                    await retellWebClient.startCall({
                        accessToken: data.access_token,
                    });
                    isCalling = true;
                    toggleBtn.disabled = false;

                } catch (err) {
                    console.error(err);
                    statusEl.textContent = "Hata: Sunucuya baƒülanƒ±lamadƒ±";
                    statusEl.className = "status error";
                    toggleBtn.disabled = false;
                }
            }
        });

        // Outbound Call Logic
        const callBtn = document.getElementById('callBtn');
        const phoneInput = document.getElementById('phoneNumber');
        const phoneStatus = document.getElementById('phoneStatus');

        callBtn.addEventListener('click', async () => {
            const number = phoneInput.value;
            if (!number) {
                phoneStatus.textContent = "L√ºtfen numara girin!";
                phoneStatus.className = "status error";
                return;
            }

            callBtn.disabled = true;
            callBtn.textContent = "Aranƒ±yor...";
            phoneStatus.textContent = "Arama ba≈ülatƒ±lƒ±yor...";
            phoneStatus.className = "status";

            try {
                const response = await fetch("/create-phone-call", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to_number: number })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || "Hata olu≈ütu");
                }

                const data = await response.json();
                phoneStatus.textContent = "‚úÖ Arama Ba≈ülatƒ±ldƒ±! Telefonunuz √ßalacak.";
                phoneStatus.className = "status active";
                callBtn.textContent = "Tekrar Ara";

            } catch (err) {
                console.error(err);
                phoneStatus.textContent = "‚ùå Hata: " + err.message;
                phoneStatus.className = "status error";
                callBtn.textContent = "Telefonumu Ara";
            } finally {
                callBtn.disabled = false;
            }
        });
    </script>
</body>

</html>